# 俺とModelとAPI

!SLIDE

# 自己紹介

Perl日誌というblogを書いています。

http://d.hatena.ne.jp/okamuuu

最近Perlと関係ない仕事ばかりやっています。

!SLIDE

# 俺が考えるModelとAPI 

俺はModelをこう考える

 * DB操作、WebAPIへのリクエストなどプログラム内部の操作を抽象化
 * 使い方を誤ると例外が発生
 * Web::Controller、CLIなどから直接実行しないほうが良い
 * アプリケーションに必要な機能を実装する

APIをこう考える

 * アプリケーションの要件を満たすインターフェースを実装する
 * 具体的な機能はModelに実装されているのでそれらを組み合わせる
 * どんな使い方をしても例外は起きないように実装する
 * 例外の代わりにstatus messages, error messagesとして保持する
 * Web::Controller、CLIなどがこれを実行する

!SLIDE

# APIというレイヤーを必要だと思った理由1

 * 複数人で開発を進めるとModelというレイヤーが広くなる
 * Model内に上位レイヤーと下位レイヤーができあがる
 * 例外補足処理が共通化できる箇所が生まれる
 * Modelに例外処理を埋め込む事になる
 * Model内の上位レイヤーは例外を補足する記述をする
 * Model内に例外を起こすものとそうでないものが生まれる
 * Modelよりもさらに上位のレイヤーが欲しい

!SLIDE

# APIというレイヤーを必要だと思った理由2

 * 開発中に処理時間を計測したい
 * ユーザーがどのような操作をして、その処理は何秒かかるのか？
 * 思いつくのはDecoratorパターン。どのように実装する？
 * Modelという名前空間よりも上位となるレイヤーが欲しい

!SLIDE

# APIというレイヤーを必要だと思った理由3

 * 入力された値が適切かどうかをチェックするValidation
 * Web::ControllerがValidationを呼び出しているのは妥当か？
 * CLIから実行した場合、CLIにもValidationを記述する事になる。
 * skinny Controller, fat Modelだよね？
 * App::ValidationとApp::Modelをまとめるレイヤーがあるとskinny Controllerに近づく
 * やっぱもう一個レイヤーが欲しい

!SLIDE

# 結果、APIが欲しくなった
 
 * Web::ControllerとModelの間にもう一つレイヤーが欲しい
 * APIという名前に固執はしないが、どう考えてもAPIという名前がしっくりする
 * でもAPIとか言うと、「何だよAPIって？」とか言われる
 * 必要なのは例外処理やロギングの処理をどこに実装するかというルール

!SLIDE

# 必ずAPIを通すのか？

 * show, listingなどRead処理でいちいちApiを実装するのは面倒
 * 例外処理やロギング正直書かないからこの場合はWeb::ControllerからModelを直接呼べばいい
 * CREATE, UPDATE, DELETEなどは重要な処理が多いのでAPIを通す
 * ソーシャルアプリなど、ユーザーがアイテムを購入する処理などで記録が残ってうれしいかも

!SLIDE

# 課題

 * トランザクションはどこに書く？
 * App::Api内でトランザクションしてね、というルールがいいのか？
 * そもそもトランザクションって抽象化できてない？
 * version number使って楽観ロックすると抽象化できる
 * 実は自分の家でやってる俺々プロジェクトでしか実装したことありません。
 
!SLIDE

# 最後に

 * 巷では俺々WaFがたくさんある。
 * でも、どういう風に実装しているのか、という話が少ない気がする。
 * 他人がどうやって実装しているのか気になる、教えて欲しい。
 * とりあえず俺はこうする。
 * みんなはどうしてる？

おしまい
 
